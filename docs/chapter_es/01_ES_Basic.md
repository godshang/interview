# ES基本概念

ES 是基于 Lucene 之上进行封装的可开箱即用的搜索引擎。其中，Lucene 提供了基于倒排序的全文索引的构建功能和查询的能力，但在更加贴近应用层的数据结构设计、存储架构层面涉及较少，它更多地被称为一个底层工具。

ES 在 Lucenne 的全文检索功能之外，还具备以下 3 个特点：

1. 自带了分布式的系统架构，能够很好地应对海量的数据，且分布式架构更加高可用，能够有效地满足生产环境的要求。
2. 支持带结构的数据（如数据库的 schema），提供了非常丰富的数据结构，可以直接映射数据库等存储的数据结构，更方便易用；
3. 另外是 ES 提供了近实时的数据索引功能，数据写入后就可以搜索查询，而不用像传统的搜索引擎要分钟级或更高的异构索引构建。

ES中的索引（Index）、类型（Type）、文档（Document）、字段（Field）对应于数据库（Database）、表（Table）、行（Row）、列（Column）等概念。但是，ES中的类型（Type）并不完全对应数据库的表，数据库中的表与表之间是隔离的，没有关联，而Es中同一个索引（Index）下的不同类型（Type）里，如果存在相同的字段，ES会认为它们是同一个字段。这个隐含逻辑对熟悉数据库概念的用户来说，有很大的迷惑性。因此，ES 从版本 5 中已经逐渐将类型（Type）移除了。或者你可以直接这样简单理解，ES 中一个索引就只能包含一个类型（Type）即可。

**什么是倒排索引**

对于倒排序索引，它是借助分词维护的二维表。文本首先通过分词器进行分词，构建出<单词, 文档ID>的一个KV结构。分词器是和各个语言特定的，中文有中文的分词器，英文有英文的分词器。

相比数据库，ES 里所有的内容都可以分词建立索引且 ES 不需要保障数据的 ACID 等特性，因此 ES 整体上更适合查询类和模糊匹配等场景。对于模糊匹配，数据库只能使用 like 等手段，性能是非常差的。

ES 里的所有内容都可以建立索引，虽然能带来提升性能的好处，但也会带来副作用，就是会非常消耗存储空间，这个在使用时需要预先考虑。

## ES的架构与深翻页

ES架构中的三个概念：节点（Node）、分片（Shard）、集群（Cluster）。

* 节点简单理解就是部署的机器，可以是物理机或者Docker。
* 分片类似是护具库分库分表架构里的一个分库，存储一部分数据。此外，分片还分为主分片和副本分片。主分片类似数据库分库里的主分库，副本分片类似从分库。分片部署在节点里，一个节点可以包含一至多个分片。
* 多个节点在一起便组成了集群。

可以看到 ES 的架构里没有代理式网关，ES 里所有的节点都可以接受用户的请求。对于类似第二小节里提到的排序+数量查询，ES 和代理式分库分表的架构比较类似，接受请求的节点并行地去获取所有其他节点，并在该节点里进行集群排序和过滤。

虽然 ES 使用了倒排序增加了检索的性能，但如果你要搜索第 1000 条数据之后的 100 条数据，在接受请求的节点就需要获取 1100*节点数量条数据，即使如 ES 这种面向查询的存储也是搞不定的。因此，ES 默认有一个设置，最多只能查询 10000 条数据，超过了直接报错。

上述描述的案例，有一个通俗的叫法：深翻页。对于深翻页，不管是 ES 和代理式网关都是无法直接支持的。解决上述问题，有一个牺牲用户体验的做法，就是按游标查询，或者叫每次查询都带上上一次查询经过排序后的最大 ID。以 SQL 举例，大致语法如下：

```
select 内容 from table where id >lastMaxId order by id limit pageSize
```

上述的有损用户体验主要体现在，用户无法指定页码进行翻页，只能在文章列表里一页一页地翻。

注意：ES 是近实时的但不是实时的，默认有 1s 的延迟。所以需要你根据具体业务情况进行取舍考虑。